<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√în t·∫≠p gi·ªØa k√¨ I ‚Äì Tin h·ªçc 8 (KNTT)</title>
  <style>
    :root{
      --bg:#f6f9fc; --card:#fff; --ink:#0f172a; --muted:#475569;
      --sky:#0ea5e9; --sky-100:#e0f2fe; --green:#10b981; --red:#ef4444;
      --amber:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:16px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .container{max-width:980px;margin:32px auto;padding:0 16px}
    h1{margin:8px 0 6px;color:var(--ink);font-weight:800}
    .sub{color:var(--muted);margin-bottom:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px;align-items:center}
    .btn{border:0;border-radius:10px;padding:10px 14px;background:var(--sky-100);color:#0c4a6e;cursor:pointer}
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:var(--sky);color:#fff}
    .btn.warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
    .card{background:var(--card);border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 2px 10px rgba(2,8,23,.06)}
    .q-title{font-weight:700;margin-bottom:10px}
    .q-img{max-width:100%;height:auto;display:block;margin:10px 0;border-radius:10px;border:1px solid #e2e8f0}
    .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;padding:8px;border-radius:10px;transition:.15s}
    .opt:hover{background:#f1f5f9}
    .muted{color:var(--muted)}
    .hint{display:none;margin-top:8px;padding:10px;border-radius:10px;background:#f8fafc;border:1px dashed #cbd5e1}
    .hint.show{display:block}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;border-radius:999px;padding:4px 10px;background:#eef2ff;color:#3730a3}
    .score{font-weight:800}
    .footer-note{margin-top:22px;color:var(--muted);font-size:13px}
    .essay-box{width:100%;min-height:110px;border:1px solid #e2e8f0;border-radius:10px;padding:10px}
    .good{color:var(--green)} .bad{color:var(--red)} .warnTxt{color:var(--amber)}
    .hr{height:1px;background:#e2e8f0;margin:18px 0}
    .error{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:12px;border-radius:12px}
    .tiny{font-size:13px}
    .explain{margin-top:8px;padding:10px;border-radius:10px;background:#f8fafc;border:1px solid #e2e8f0}
  </style>
</head>
<body>
  <div class="container">
    <h1>√în t·∫≠p Gi·ªØa K√¨ I ‚Äì Tin h·ªçc 8</h1>
    <div class="sub">Theo SGK <b>K·∫øt n·ªëi tri th·ª©c v·ªõi cu·ªôc s·ªëng</b>. Tr·∫Øc nghi·ªám + t·ª± lu·∫≠n, c√≥ g·ª£i √Ω, x√°o c√¢u &amp; ch·∫•m ƒëi·ªÉm.</div>

    <div class="toolbar">
      <button id="btnRetryNoShuffle" class="btn">üîÅ L√†m l·∫°i (gi·ªØ th·ª© t·ª±)</button>
      <button id="btnRetryShuffle" class="btn">üé≤ L√†m l·∫°i (x√°o c√¢u &amp; ƒë√°p √°n)</button>
      <button id="btnGrade" class="btn primary">‚úÖ Ch·∫•m ƒëi·ªÉm tr·∫Øc nghi·ªám</button>
      <button id="btnClearMarks" class="btn warn">üßπ X√≥a nh√£n ƒë√∫ng/sai</button>
      <span id="score" class="pill">ƒêi·ªÉm: <span class="score">0/0</span></span>
      <span id="status" class="muted tiny"></span>
    </div>

    <div id="quiz"></div>

    <div class="footer-note">M·∫πo: ƒë·ªçc kƒ© c√¢u h·ªèi, soi ‚Äút·ª´ kh√≥a‚Äù ƒë√∫ng ‚Äì <i>si√™u nƒÉng l·ª±c h·ªçc sinh th·ªùi s·ªë</i> l√† bi·∫øt ho√†i nghi c√≥ ph∆∞∆°ng ph√°p.</div>
  </div>

  <script>
    // -------------------------
    // State
    // -------------------------
    let ORIGINAL_DATA = null; // d·ªØ li·ªáu g·ªëc t·ª´ JSON
    let CURRENT_DATA  = null; // d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã (ƒë√£ x√°o n·∫øu c√≥)

    // -------------------------
    // Helpers
    // -------------------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const clone = o => JSON.parse(JSON.stringify(o));

    // Fisher‚ÄìYates
    function shuffleArray(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
    }

    function shuffleOptions(q){
      const pairs = q.options.map((t,i)=>({t,i}));
      shuffleArray(pairs);
      q.options = pairs.map(p=>p.t);
      q.answer  = pairs.findIndex(p=>p.i===q.answer);
    }

    function setStatus(msg){
      $('#status').textContent = msg || '';
    }

    function setScore(correct, total){
      $('#score .score').textContent = `${correct}/${total}`;
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // -------------------------
    // Load + Render
    // -------------------------
    async function loadData(){
      try{
        setStatus('ƒêang t·∫£i d·ªØ li·ªáu...');
        const res = await fetch('data/tin8.json', {cache:'no-store'});
        if(!res.ok) throw new Error(`Kh√¥ng t·∫£i ƒë∆∞·ª£c data/tin8.json (HTTP ${res.status})`);
        ORIGINAL_DATA = await res.json();
        render(ORIGINAL_DATA, false);
        setStatus('ƒê√£ t·∫£i xong.');
      }catch(err){
        console.error(err);
        $('#quiz').innerHTML = `
          <div class="card error">
            <b>L·ªói t·∫£i d·ªØ li·ªáu.</b>
            <div class="tiny">H√£y ki·ªÉm tra file <code>data/tin8.json</code> c√≥ t·ªìn t·∫°i ƒë√∫ng v·ªã tr√≠ v√† GitHub Pages ƒë√£ b·∫≠t.</div>
            <div class="tiny">Chi ti·∫øt: ${escapeHtml(err.message)}</div>
          </div>
        `;
        setStatus('L·ªói t·∫£i d·ªØ li·ªáu.');
        setScore(0,0);
      }
    }

    function render(raw, doShuffle){
      if(!raw) return;
      const data = clone(raw);

      if(doShuffle){
        shuffleArray(data.mcqs);
        data.mcqs.forEach(shuffleOptions);
      }

      CURRENT_DATA = data;      // ‚úÖ quan tr·ªçng: ch·∫•m theo data ƒëang hi·ªÉn th·ªã
      buildQuiz(CURRENT_DATA);  // render UI
      clearMarks();             // reset nh√£n ƒë√∫ng/sai
      setScore(0, CURRENT_DATA.mcqs.length);
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // -------------------------
    // UI Builder
    // -------------------------
    function buildQuiz(data){
      const root = $('#quiz');
      root.innerHTML = '';

      // --- PH·∫¶N TR·∫ÆC NGHI·ªÜM ---
      root.insertAdjacentHTML('beforeend', `
        <div class="card">
          <div class="q-title">PH·∫¶N TR·∫ÆC NGHI·ªÜM</div>
          <div class="muted">Ch·ªçn 1 ƒë√°p √°n ƒë√∫ng cho m·ªói c√¢u.</div>
        </div>
      `);

      data.mcqs.forEach((q, idx)=>{
        const qid = `q${idx}`;
        const imgHtml = q.img ? `<img class="q-img" src="${escapeHtml(q.img)}" alt="minh h·ªça c√¢u ${idx+1}">` : '';

        const optsHtml = q.options.map((opt, oi)=>`
          <label class="opt">
            <input type="radio" name="${qid}" value="${oi}"/>
            <span>${String.fromCharCode(65+oi)}. ${escapeHtml(opt)}</span>
          </label>
        `).join('');

        const hintText = q.hint ? escapeHtml(q.hint) : 'H√£y suy lu·∫≠n d·ª±a tr√™n kh√°i ni·ªám trong b√†i h·ªçc.';

        const explainHtml = q.explain ? `<div class="explain tiny"><b>Gi·∫£i th√≠ch:</b> ${escapeHtml(q.explain)}</div>` : '';

        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.qindex = String(idx);

        card.innerHTML = `
          <div class="q-title" data-base="1">C√¢u ${idx+1}: ${escapeHtml(q.stem)}</div>
          ${imgHtml}
          <div>${optsHtml}</div>

          <div class="toolbar" style="margin-top:8px">
            <button class="btn hint-btn" type="button">üí° G·ª£i √Ω</button>
          </div>
          <div class="hint">${hintText}</div>

          <div class="result tiny muted" style="margin-top:10px"></div>
          <div class="explain-wrap" style="display:none">${explainHtml}</div>
        `;
        root.appendChild(card);

        $('.hint-btn', card).addEventListener('click', ()=>{
          $('.hint', card).classList.toggle('show');
        });
      });

      // --- PH·∫¶N T·ª∞ LU·∫¨N (n·∫øu c√≥ trong JSON) ---
      if(Array.isArray(data.essay) && data.essay.length){
        root.insertAdjacentHTML('beforeend', `
          <div class="card">
            <div class="q-title">PH·∫¶N T·ª∞ LU·∫¨N</div>
            <div class="muted">Tr·∫£ l·ªùi ng·∫Øn g·ªçn, n√™u r√µ lu·∫≠n ƒëi·ªÉm &amp; v√≠ d·ª•.</div>
          </div>
        `);

        data.essay.forEach((e)=>{
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="q-title">${escapeHtml(e.title || 'T·ª± lu·∫≠n')}</div>
            <div class="muted" style="white-space:pre-line">${escapeHtml(e.prompt || '')}</div>
            <textarea class="essay-box" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa em..."></textarea>
            <div class="hr"></div>
            <details>
              <summary class="muted">G·ª£i √Ω ch·∫•m/√Ω ch√≠nh</summary>
              <div class="hint show" style="display:block">${escapeHtml(e.rubric || '')}</div>
            </details>
          `;
          root.appendChild(card);
        });
      }
    }

    // -------------------------
    // Grading
    // -------------------------
    function clearMarks(){
      // x√≥a nh√£n ƒë√∫ng/sai c≈©
      $$('.card[data-qindex]').forEach(card=>{
        const title = $('.q-title', card);
        const base = title.getAttribute('data-base-html');
        if(base){
          title.innerHTML = base;
        }else{
          // l∆∞u b·∫£n g·ªëc l·∫ßn ƒë·∫ßu
          title.setAttribute('data-base-html', title.innerHTML);
        }
        const result = $('.result', card);
        result.textContent = '';
        const exWrap = $('.explain-wrap', card);
        if(exWrap) exWrap.style.display = 'none';
      });
    }

    function grade(){
      if(!CURRENT_DATA || !Array.isArray(CURRENT_DATA.mcqs)) return;

      clearMarks();

      let correct = 0;
      const total = CURRENT_DATA.mcqs.length;

      $$('.card[data-qindex]').forEach(card=>{
        const iQ = Number(card.dataset.qindex);
        const q  = CURRENT_DATA.mcqs[iQ];

        const title = $('.q-title', card);
        const name  = `q${iQ}`;
        const picked = card.querySelector(`input[name="${name}"]:checked`);

        const pickedIndex = picked ? Number(picked.value) : null;
        const ansIndex = Number(q.answer);

        const baseHtml = title.getAttribute('data-base-html') || title.innerHTML;

        if(pickedIndex === null){
          title.innerHTML = `${baseHtml} <span class="warnTxt">‚ö† Ch∆∞a ch·ªçn</span>`;
        }else if(pickedIndex === ansIndex){
          correct++;
          title.innerHTML = `${baseHtml} <span class="good">‚úî ƒê√∫ng</span>`;
        }else{
          title.innerHTML = `${baseHtml} <span class="bad">‚úò Sai</span>`;
        }

        // hi·ªán ƒë√°p √°n ƒë√∫ng (v√† b·∫°n ch·ªçn)
        const result = $('.result', card);
        const correctLetter = String.fromCharCode(65 + ansIndex);
        const pickedLetter  = pickedIndex === null ? '‚Äî' : String.fromCharCode(65 + pickedIndex);

        result.innerHTML = `ƒê√°p √°n ƒë√∫ng: <b>${correctLetter}</b> ‚Ä¢ B·∫°n ch·ªçn: <b>${pickedLetter}</b>`;

        // n·∫øu c√≥ gi·∫£i th√≠ch trong JSON th√¨ show khi ch·∫•m
        const exWrap = $('.explain-wrap', card);
        if(exWrap && exWrap.innerHTML.trim()){
          exWrap.style.display = 'block';
        }
      });

      setScore(correct, total);
      setStatus(`ƒê√£ ch·∫•m xong: ${correct}/${total}`);
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // -------------------------
    // Boot
    // -------------------------
    window.addEventListener('DOMContentLoaded', ()=>{
      $('#btnRetryNoShuffle').addEventListener('click', ()=> render(ORIGINAL_DATA, false));
      $('#btnRetryShuffle').addEventListener('click', ()=> render(ORIGINAL_DATA, true));
      $('#btnGrade').addEventListener('click', grade);
      $('#btnClearMarks').addEventListener('click', ()=>{
        clearMarks();
        setScore(0, CURRENT_DATA?.mcqs?.length ?? 0);
        setStatus('ƒê√£ x√≥a nh√£n ƒë√∫ng/sai.');
      });

      loadData();
    });
  </script>
</body>
</html>
