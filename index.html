<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√în t·∫≠p cu√¥ÃÅi HoÃ£c k√¨ I ‚Äì Tin h·ªçc 8 (KNTT)</title>
  <style>
    :root{
      --bg:#f6f9fc; --card:#fff; --ink:#0f172a; --muted:#475569;
      --sky:#0ea5e9; --sky-100:#e0f2fe; --green:#10b981; --red:#ef4444;
      --amber:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:16px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .container{max-width:980px;margin:32px auto;padding:0 16px}
    h1{margin:8px 0 6px;color:var(--ink);font-weight:800}
    .sub{color:var(--muted);margin-bottom:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px;align-items:center}
    .btn{border:0;border-radius:10px;padding:10px 14px;background:var(--sky-100);color:#0c4a6e;cursor:pointer}
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:var(--sky);color:#fff}
    .btn.warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
    .card{background:var(--card);border-radius:14px;padding:18px;margin:14px 0;box-shadow:0 2px 10px rgba(2,8,23,.06)}
    .q-title{font-weight:700;margin-bottom:10px}
    .q-img{max-width:100%;height:auto;display:block;margin:10px 0;border-radius:10px;border:1px solid #e2e8f0}
    .opt{display:flex;gap:8px;align-items:flex-start;margin:6px 0;padding:8px;border-radius:10px;transition:.15s}
    .opt:hover{background:#f1f5f9}
    .opt img{max-width:100%;height:auto;display:block;border-radius:10px;border:1px solid #e2e8f0}
    .muted{color:var(--muted)}
    .hint{display:none;margin-top:8px;padding:10px;border-radius:10px;background:#f8fafc;border:1px dashed #cbd5e1}
    .hint.show{display:block}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;border-radius:999px;padding:4px 10px;background:#eef2ff;color:#3730a3}
    .score{font-weight:800}
    .footer-note{margin-top:22px;color:var(--muted);font-size:13px}
    .good{color:var(--green)} .bad{color:var(--red)} .warnTxt{color:var(--amber)}
    .error{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:12px;border-radius:12px}
    .tiny{font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <h1>√în t·∫≠p cu√¥ÃÅi HoÃ£c k√¨ I ‚Äì Tin h·ªçc 8</h1>
    <div class="sub">Theo SGK <b>K·∫øt n·ªëi tri th·ª©c v·ªõi cu·ªôc s·ªëng</b>. Tr·∫Øc nghi·ªám c√≥ g·ª£i √Ω, x√°o c√¢u &amp; ch·∫•m ƒëi·ªÉm.</div>

    <div class="toolbar">
      <button id="btnRetryNoShuffle" class="btn">üîÅ L√†m l·∫°i (gi·ªØ th·ª© t·ª±)</button>
      <button id="btnRetryShuffle" class="btn">üé≤ L√†m l·∫°i (x√°o c√¢u &amp; ƒë√°p √°n)</button>
      <button id="btnGrade" class="btn primary">‚úÖ Ch·∫•m ƒëi·ªÉm tr·∫Øc nghi·ªám</button>
      <button id="btnClearMarks" class="btn warn">üßπ X√≥a nh√£n ƒë√∫ng/sai</button>
      <span id="score" class="pill">ƒêi·ªÉm: <span class="score">0/0</span></span>
      <span id="status" class="muted tiny"></span>
    </div>

    <div id="quiz"></div>

    <div class="footer-note">M·∫πo: ƒë·ªçc kƒ© c√¢u h·ªèi, soi ‚Äút·ª´ kh√≥a‚Äù ƒë√∫ng.</div>
  </div>

  <script>
    let ORIGINAL_DATA = null; // d·∫°ng chu·∫©n n·ªôi b·ªô: { mcqs: [...] }
    let CURRENT_DATA  = null;

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const clone = o => JSON.parse(JSON.stringify(o));

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // Fisher‚ÄìYates
    function shuffleArray(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
    }

    function shuffleOptions(q){
      const pairs = q.options.map((opt,i)=>({opt,i}));
      shuffleArray(pairs);
      q.options = pairs.map(p=>p.opt);
      if(q.answer !== null && q.answer !== undefined){
        q.answer = pairs.findIndex(p=>p.i===q.answer);
      }
    }

    function setStatus(msg){ $('#status').textContent = msg || ''; }
    function setScore(correct, total){ $('#score .score').textContent = `${correct}/${total}`; }

    // --- FIX PATH: n·∫øu JSON ƒë·ªÉ "images/..." th√¨ t·ª± chuy·ªÉn th√†nh "data/images/..."
    function normalizeImagePath(p){
      if(!p) return null;
      // ƒë√£ ƒë√∫ng "data/images/..." th√¨ gi·ªØ
      if(p.startsWith('data/')) return p;
      // n·∫øu b·∫Øt ƒë·∫ßu b·∫±ng "images/..." => th√™m "data/"
      if(p.startsWith('images/')) return 'data/' + p;
      // tr∆∞·ªùng h·ª£p kh√°c: gi·ªØ nguy√™n
      return p;
    }

    // --- CHUY·ªÇN JSON C·ª¶A B·∫†N (m·∫£ng) -> d·∫°ng chu·∫©n n·ªôi b·ªô
    // JSON b·∫°n ƒëang c√≥:
    // [
    //   { question, choices:[{key,text,image?}], questionImage?, answer:null/'A'/0... }
    // ]
    function normalizeRawJson(raw){
      // N·∫øu ƒë√£ l√† d·∫°ng {mcqs:[...]} th√¨ d√πng lu√¥n
      if(raw && typeof raw === 'object' && Array.isArray(raw.mcqs)){
        raw.mcqs.forEach(q=>{
          if(q.img) q.img = normalizeImagePath(q.img);
          if(Array.isArray(q.options)){
            q.options = q.options.map(opt=>{
              if(opt && typeof opt === 'object' && opt.image){
                opt.image = normalizeImagePath(opt.image);
              }
              return opt;
            });
          }
        });
        return raw;
      }

      // N·∫øu l√† m·∫£ng (ƒë√∫ng nh∆∞ file b·∫°n paste)
      if(Array.isArray(raw)){
        const mcqs = raw.map((item)=> {
          const stem = item.question ?? '';
          const img = normalizeImagePath(item.questionImage);

          // options: c√≥ th·ªÉ l√† text th∆∞·ªùng ho·∫∑c ·∫£nh (c√¢u 22)
          const options = (item.choices || []).map(ch => ({
            key: ch.key ?? '',
            text: ch.text ?? '',
            image: normalizeImagePath(ch.image)
          }));

          // answer: c√≥ th·ªÉ null, ho·∫∑c "A"/"B"/..., ho·∫∑c s·ªë index
          let answerIndex = null;
          if(item.answer !== null && item.answer !== undefined){
            if(typeof item.answer === 'number'){
              answerIndex = item.answer;
            }else if(typeof item.answer === 'string'){
              const s = item.answer.trim().toUpperCase();
              const map = {A:0,B:1,C:2,D:3};
              if(map[s] !== undefined) answerIndex = map[s];
            }
          }

          return {
            id: item.id ?? '',
            stem,
            img,
            // render d√πng options d·∫°ng object ƒë·ªÉ h·ªó tr·ª£ ·∫£nh
            options,
            answer: answerIndex,
            hint: item.hint ?? ''
          };
        });

        return { mcqs, essay: [] };
      }

      // fallback
      return { mcqs: [], essay: [] };
    }

    async function loadData(){
      try{
        setStatus('ƒêang t·∫£i d·ªØ li·ªáu...');
        const res = await fetch('data/tin8.json', {cache:'no-store'});
        if(!res.ok) throw new Error(`Kh√¥ng t·∫£i ƒë∆∞·ª£c data/tin8.json (HTTP ${res.status})`);
        const raw = await res.json();

        ORIGINAL_DATA = normalizeRawJson(raw);
        render(ORIGINAL_DATA, false);

        setStatus('ƒê√£ t·∫£i xong.');
      }catch(err){
        console.error(err);
        $('#quiz').innerHTML = `
          <div class="card error">
            <b>L·ªói t·∫£i d·ªØ li·ªáu.</b>
            <div class="tiny">H√£y ki·ªÉm tra file <code>data/tin8.json</code> c√≥ ƒë√∫ng ƒë·ªãnh d·∫°ng JSON v√† ƒë√∫ng v·ªã tr√≠.</div>
            <div class="tiny">Chi ti·∫øt: ${escapeHtml(err.message)}</div>
          </div>
        `;
        setStatus('L·ªói t·∫£i d·ªØ li·ªáu.');
        setScore(0,0);
      }
    }

    function render(raw, doShuffle){
      const data = clone(raw);

      if(doShuffle){
        shuffleArray(data.mcqs);
        data.mcqs.forEach(shuffleOptions);
      }

      CURRENT_DATA = data;
      buildQuiz(CURRENT_DATA);
      clearMarks();
      // t·ªïng ƒë·ªÉ ch·∫•m = s·ªë c√¢u c√≥ answer != null
      const gradable = CURRENT_DATA.mcqs.filter(q => q.answer !== null && q.answer !== undefined).length;
      setScore(0, gradable);
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function buildQuiz(data){
      const root = $('#quiz');
      root.innerHTML = '';

      root.insertAdjacentHTML('beforeend', `
        <div class="card">
          <div class="q-title">PH·∫¶N TR·∫ÆC NGHI·ªÜM</div>
          <div class="muted">Ch·ªçn 1 ƒë√°p √°n ƒë√∫ng cho m·ªói c√¢u.</div>
          <div class="muted tiny">L∆∞u √Ω: c√¢u n√†o <b>ch∆∞a c√≥ ƒë√°p √°n</b> (answer = null) s·∫Ω <b>kh√¥ng t√≠nh ƒëi·ªÉm</b>.</div>
        </div>
      `);

      data.mcqs.forEach((q, idx)=>{
        const qid = `q${idx}`;
        const imgHtml = q.img ? `<img class="q-img" src="${escapeHtml(q.img)}" alt="minh h·ªça c√¢u ${idx+1}">` : '';

        const optsHtml = (q.options || []).map((opt, oi)=>{
          const label = String.fromCharCode(65+oi);
          const content = opt.image
            ? `<img src="${escapeHtml(opt.image)}" alt="ƒê√°p √°n ${label}">`
            : `<span>${escapeHtml(opt.text)}</span>`;
          return `
            <label class="opt">
              <input type="radio" name="${qid}" value="${oi}"/>
              <span><b>${label}.</b> ${content}</span>
            </label>
          `;
        }).join('');

        const hintText = q.hint ? escapeHtml(q.hint) : 'H√£y suy lu·∫≠n d·ª±a tr√™n kh√°i ni·ªám trong b√†i h·ªçc.';

        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.qindex = String(idx);

        card.innerHTML = `
          <div class="q-title" data-base="1">C√¢u ${idx+1}: ${escapeHtml(q.stem)}</div>
          ${imgHtml}
          <div>${optsHtml}</div>

          <div class="toolbar" style="margin-top:8px">
            <button class="btn hint-btn" type="button">üí° G·ª£i √Ω</button>
          </div>
          <div class="hint">${hintText}</div>

          <div class="result tiny muted" style="margin-top:10px"></div>
        `;
        root.appendChild(card);

        $('.hint-btn', card).addEventListener('click', ()=>{
          $('.hint', card).classList.toggle('show');
        });
      });
    }

    function clearMarks(){
      $$('.card[data-qindex]').forEach(card=>{
        const title = $('.q-title', card);
        const base = title.getAttribute('data-base-html');
        if(base){
          title.innerHTML = base;
        }else{
          title.setAttribute('data-base-html', title.innerHTML);
        }
        $('.result', card).textContent = '';
      });
    }

    function grade(){
      if(!CURRENT_DATA || !Array.isArray(CURRENT_DATA.mcqs)) return;

      clearMarks();

      let correct = 0;
      let total = 0;

      $$('.card[data-qindex]').forEach(card=>{
        const iQ = Number(card.dataset.qindex);
        const q  = CURRENT_DATA.mcqs[iQ];

        const title = $('.q-title', card);
        const name  = `q${iQ}`;
        const picked = card.querySelector(`input[name="${name}"]:checked`);
        const pickedIndex = picked ? Number(picked.value) : null;

        const ansIndex = (q.answer === null || q.answer === undefined) ? null : Number(q.answer);
        const baseHtml = title.getAttribute('data-base-html') || title.innerHTML;

        // N·∫øu ch∆∞a c√≥ ƒë√°p √°n chu·∫©n -> kh√¥ng ch·∫•m, ch·ªâ b√°o
        if(ansIndex === null){
          title.innerHTML = `${baseHtml} <span class="warnTxt">‚ö† Ch∆∞a c√≥ ƒë√°p √°n (kh√¥ng t√≠nh ƒëi·ªÉm)</span>`;
          if(pickedIndex === null){
            $('.result', card).textContent = `B·∫°n ch∆∞a ch·ªçn.`;
          }else{
            const pickedLetter = String.fromCharCode(65 + pickedIndex);
            $('.result', card).textContent = `B·∫°n ch·ªçn: ${pickedLetter}. (C√¢u n√†y ch∆∞a c√≥ ƒë√°p √°n ƒë·ªÉ ch·∫•m)`;
          }
          return;
        }

        // C√≥ ƒë√°p √°n -> ch·∫•m
        total++;
        if(pickedIndex === null){
          title.innerHTML = `${baseHtml} <span class="warnTxt">‚ö† Ch∆∞a ch·ªçn</span>`;
        }else if(pickedIndex === ansIndex){
          correct++;
          title.innerHTML = `${baseHtml} <span class="good">‚úî ƒê√∫ng</span>`;
        }else{
          title.innerHTML = `${baseHtml} <span class="bad">‚úò Sai</span>`;
        }

        const correctLetter = String.fromCharCode(65 + ansIndex);
        const pickedLetter  = pickedIndex === null ? '‚Äî' : String.fromCharCode(65 + pickedIndex);
        $('.result', card).innerHTML = `ƒê√°p √°n ƒë√∫ng: <b>${correctLetter}</b> ‚Ä¢ B·∫°n ch·ªçn: <b>${pickedLetter}</b>`;
      });

      setScore(correct, total);
      setStatus(`ƒê√£ ch·∫•m xong: ${correct}/${total}`);
      window.scrollTo({top:0, behavior:'smooth'});
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      $('#btnRetryNoShuffle').addEventListener('click', ()=> render(ORIGINAL_DATA, false));
      $('#btnRetryShuffle').addEventListener('click', ()=> render(ORIGINAL_DATA, true));
      $('#btnGrade').addEventListener('click', grade);
      $('#btnClearMarks').addEventListener('click', ()=>{
        clearMarks();
        const gradable = CURRENT_DATA?.mcqs?.filter(q => q.answer !== null && q.answer !== undefined).length ?? 0;
        setScore(0, gradable);
        setStatus('ƒê√£ x√≥a nh√£n ƒë√∫ng/sai.');
      });

      loadData();
    });
  </script>
</body>
</html>
